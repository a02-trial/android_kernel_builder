name: Kernel Build CI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Load config.env to GITHUB_ENV
      run: |
        while IFS='=' read -r key value; do
          if [[ ! "$key" =~ ^# && "$key" != "" ]]; then
            echo "$key=$value" >> $GITHUB_ENV
          fi
        done < config.env

    - name: Get Date & Time
      id: date
      run: |
        echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
        echo "time=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Send Telegram Notification (Build Triggered)
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message_thread_id: ${{ secrets.MESSAGE_THREAD_ID }}
        parse_mode: MarkdownV2
        message: |
          *ğŸ¦ Build Kernel Triggered* 
          
          ğŸ“± *Device* : `${{ env.DEVICE_CODENAME }}`  
          âŒ› *Estimated Time* : Â±7â€“15 mins  
          ğŸ“… *Date* : ${{ steps.date.outputs.date }}  
          ğŸ• *Time* : ${{ steps.date.outputs.time }}  
          ğŸš€ *Compiler* : Proton Clang

    - name: Setup Build Environment
      run: |
        sudo apt update
        sudo apt install -y bc bison flex libssl-dev libncurses-dev curl git zip

    - name: Set build.sh as Executable
      run: chmod +x build.sh

    - name: Run Kernel Builder
      run: ./build.sh

    - name: Upload Flashable Kernel ZIP
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Flashable-Kernel
        path: AnyKernel3/*.zip

    - name: Send Telegram Notification (Success)
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message_thread_id: ${{ secrets.MESSAGE_THREAD_ID }}
        parse_mode: MarkdownV2
        message: |
          *âœ… Build Success!* 
          
          ğŸ“± *Device* : `${{ env.DEVICE_CODENAME }}`  
          ğŸ“¦ *Output* : ZIP uploaded to Artifacts  
          ğŸ”— *Repo* : `${{ github.repository }}`  
          ğŸ‘¤ *Built by* : `${{ github.actor }}`

    - name: Send Telegram Notification (Failed)
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message_thread_id: ${{ secrets.MESSAGE_THREAD_ID }}
        parse_mode: MarkdownV2
        message: |
          *âŒ Build Gagal!* 
          
          ğŸ“± *Device* : `${{ env.DEVICE_CODENAME }}`  
          ğŸ§¾ *Error Log* : Check Actions tab  
          ğŸ”— *Commit* : `${{ github.sha }}`  
          ğŸ‘¤ *Built by* : `${{ github.actor }}`
