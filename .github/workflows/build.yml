name: Kernel Build CI

on:
  workflow_dispatch:  # âŒ Auto-push trigger dihapus, aman dari build mendadak

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      KERNEL_CONFIG: begonia_user_defconfig
      LOCALVERSION: axira-begonia
      MESSAGE_THREAD_ID: 177894  # âœ… ID topik Telegram

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Get Date & Time
      id: date
      run: |
        echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
        echo "time=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Send Telegram Notification (Build Triggered)
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message_thread_id: ${{ env.MESSAGE_THREAD_ID }}
        message: |
          ğŸ¦ Build Dimulai  
          âŒ› Estimated Time : Â±7â€“15 mins  
          ğŸ“… Date : ${{ steps.date.outputs.date }}  
          ğŸ• Time : ${{ steps.date.outputs.time }}  
          ğŸš€ Builder : Lilium Kernel CI

    - name: Setup Build Environment
      run: |
        sudo apt update
        sudo apt install -y bc bison flex libssl-dev libncurses-dev curl git zip

    - name: Set build.sh as Executable
      run: chmod +x build.sh

    - name: Run Kernel Builder
      run: ./build.sh

    - name: Upload Flashable Kernel ZIP
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Flashable-Kernel
        path: AnyKernel3/*.zip

    - name: Send Telegram Notification (Success)
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message_thread_id: ${{ env.MESSAGE_THREAD_ID }}
        message: |
          âœ… Build Success!  
          ğŸ“¦ Output : ZIP uploaded to Artifacts  
          ğŸ”— Repo : ${{ github.repository }}  
          ğŸ‘¤ Built by : ${{ github.actor }}

    - name: Send Telegram Notification (Failed)
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message_thread_id: ${{ env.MESSAGE_THREAD_ID }}
        message: |
          âŒ Build Gagal!  
          ğŸ§¾ Error Log : Check Actions tab  
          ğŸ”— Commit : ${{ github.sha }}  
          ğŸ‘¤ Built by : ${{ github.actor }}
