name: Kernel Build CI

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      KERNEL_CONFIG: vendor/device_defconfig
      LOCALVERSION: lilium-rengoku

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Get Date & Time
      id: date
      run: |
        echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
        echo "time=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT

    - name: Send Telegram Notification (Build Triggered)
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          #KernelBuildTriggered

          📱 Device : ${{ env.KERNEL_CONFIG }}
          📅 Date : ${{ steps.date.outputs.date }}
          🕐 Time : ${{ steps.date.outputs.time }}
          🚀 Builder : Lilium Kernel CI

    - name: Setup Build Environment
      run: |
        sudo apt update
        sudo apt install -y bc bison flex libssl-dev libncurses-dev curl git zip

    - name: Set build.sh as Executable
      run: chmod +x build.sh

    - name: Run Kernel Builder
      run: ./build.sh

    - name: Upload Flashable Kernel ZIP
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Flashable-Kernel
        path: AnyKernel3/*.zip

    - name: Send Telegram Notification (Success)
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ✅ Build Success!

          📱 Device : ${{ env.KERNEL_CONFIG }}
          📦 Output : ZIP uploaded to Artifacts
          🔗 Repo : ${{ github.repository }}
          👤 Built by : ${{ github.actor }}

    - name: Send Telegram Notification (Failed)
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ❌ Build Failed!

          📱 Device : ${{ env.KERNEL_CONFIG }}
          🧾 Error Log : Check Actions tab
          🔗 Commit : ${{ github.sha }}
          👤 Built by : ${{ github.actor }}
