name: Kernel Build CI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Load config.env to GITHUB_ENV
      run: |
        while IFS='=' read -r key value; do
          if [[ ! "$key" =~ ^# && "$key" != "" ]]; then
            echo "$key=$value" >> $GITHUB_ENV
          fi
        done < config.env

    - name: Get Date & Time (WIB)
      id: date
      run: |
        echo "date=$(TZ='Asia/Jakarta' date +'%Y%m%d')" >> $GITHUB_OUTPUT
        echo "time=$(TZ='Asia/Jakarta' date +'%H:%M:%S WIB')" >> $GITHUB_OUTPUT

    - name: Send Telegram Notification (Triggered)
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message_thread_id: ${{ secrets.MESSAGE_THREAD_ID }}
        parse_mode: MarkdownV2
        message: |
          *ğŸˆ Build Kernel Triggered By `${{ github.actor }}`*

          *ğŸ“± Device* : `${{ env.DEVICE_CODENAME }}`
          *ğŸ“… Date Build* : `${{ steps.date.outputs.date }}`
          *ğŸ• Jam Build* : `${{ steps.date.outputs.time }}`
          *ğŸ¦ Build Variant* : `${{ env.BUILD_VARIANT }}`

    - name: Setup Build Environment
      run: |
        sudo apt update
        sudo apt install -y bc bison flex libssl-dev libncurses-dev curl git zip

    - name: Set build.sh as Executable
      run: chmod +x build.sh

    - name: Run Kernel Builder
      run: ./build.sh

    - name: Upload Flashable Kernel ZIP
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Flashable-Kernel
        path: AnyKernel3/*.zip

    - name: Send Telegram Notification (Success)
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message_thread_id: ${{ secrets.MESSAGE_THREAD_ID }}
        parse_mode: MarkdownV2
        message: |
          *âœ… Build Berhasil!*

          *ğŸ“± Device* : `${{ env.DEVICE_CODENAME }}`
          *ğŸ“… Date Build* : `${{ steps.date.outputs.date }}`
          *ğŸ• Jam Build* : `${{ steps.date.outputs.time }}`
          *ğŸ¦ Build Variant* : `${{ env.BUILD_VARIANT }}`

          ğŸ“¦ ZIP uploaded to Artifacts  
          ğŸ”— Repo : `${{ github.repository }}`  
          ğŸ‘¤ Built by : `${{ github.actor }}`

    - name: Send Telegram Notification (Failed)
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message_thread_id: ${{ secrets.MESSAGE_THREAD_ID }}
        parse_mode: MarkdownV2
        message: |
          *ğŸ’€ Build Gagal!*

          *ğŸ“± Device* : `${{ env.DEVICE_CODENAME }}`
          *ğŸ“… Date Build* : `${{ steps.date.outputs.date }}`
          *ğŸ• Jam Build* : `${{ steps.date.outputs.time }}`
          *ğŸ¦ Build Variant* : `${{ env.BUILD_VARIANT }}`

          ğŸ§¾ Error Log : Check Actions tab  
          ğŸ”— Commit : `${{ github.sha }}`  
          ğŸ‘¤ Built by : `${{ github.actor }}`
